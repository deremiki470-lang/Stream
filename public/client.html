<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Klient - Support QR</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  height: 100vh;
  margin: 0;
  background: #fafafa;
}
#qr { margin-top: 12px; }
#msg { color: #333; text-align: center; }
img.logo { width: 100px; margin-bottom: 8px; }
</style>
</head>
<body>
  <img src="https://i.postimg.cc/WzDHPTPX/logo.jpg" class="logo" alt="logo">
  <h2 id="msg">Verifierar session...</h2>
  <div id="qr"></div>

  <script>
  (async () => {
    const msg = document.getElementById('msg');
    const qrDiv = document.getElementById('qr');

    // Steg 1 – verifiera session med servern
    try {
      const res = await fetch('/api/verify', { credentials: 'same-origin' });
      const obj = await res.json();

      if (!obj.valid) {
        msg.textContent = 'Åtkomst nekad: ogiltig session. Ladda om sidan.';
        return;
      }

      msg.textContent = `Välkommen, ${obj.username} — ansluter...`;
    } catch (err) {
      msg.textContent = 'Serververifiering misslyckades. Försök igen senare.';
      console.error(err);
      return;
    }

    // Steg 2 – anslut via Socket.IO
    const socket = io();
    socket.emit('join', 'client');

    socket.on('connected', (ok) => {
      if (!ok) {
        msg.textContent = 'Frånkopplad / ingen aktiv sändning';
        qrDiv.innerHTML = '';
        return;
      }
      msg.textContent = 'Ansluten — väntar på QR...';
    });

    let adminPresent = true;
    function setAdminPresent(present) {
      adminPresent = !!present;
      if (!adminPresent) {
        msg.textContent = 'Återansluter... väntar på administratör';
        qrDiv.innerHTML = '';
      }
    }
    socket.on('admin_present', (present) => setAdminPresent(present));

    setInterval(async () => {
      if (adminPresent) return;
      try {
        const res = await fetch('/api/verify', { credentials: 'same-origin' });
        const obj = await res.json();
        if (obj.valid) socket.emit('join', 'client');
      } catch (_) {}
    }, 3000);

    socket.on('qr_update', (value) => {
      qrDiv.innerHTML = '';
      if (value) {
        msg.textContent = 'QR aktiv';
        new QRCode(qrDiv, { text: value, width: 256, height: 256 });
      } else {
        msg.textContent = 'QR dold eller inte tillgänglig';
      }
    });

    socket.on('forbidden', (m) => {
      msg.textContent = m || 'Åtkomst nekad';
      setTimeout(() => socket.disconnect(), 100);
    });

    socket.on('ping', (t) => socket.emit('pong', t));
  })();
  </script>
</body>
</html>
