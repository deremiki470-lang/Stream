<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Klient - Support QR</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  height: 100vh;
  margin: 0;
  background: #fafafa;
}
#qr { margin-top: 12px; }
#msg { color: #333; text-align: center; }
.logo { width: 100px; margin-bottom: 8px; }
</style>
</head>
<body>
  <img src="https://i.postimg.cc/WzDHPTPX/logo.jpg" class="logo" alt="logo">
  <h2 id="msg">Verifierar session...</h2>
  <div id="qr"></div>

<script>
(async () => {
  const msg = document.getElementById('msg');
  const qrDiv = document.getElementById('qr');

  // Steg 1 — verifiera cookie-session med servern
  try {
    const res = await fetch('/api/verify', { credentials: 'same-origin' });
    const obj = await res.json();

    if (!obj.valid) {
      msg.textContent = 'Åtkomst nekad: ogiltig session.';
      setTimeout(() => window.location.href = '/login', 1200);
      return;
    }

    msg.textContent = `Välkommen, ${obj.username} — ansluter...`;
  } catch (err) {
    msg.textContent = 'Serververifiering misslyckades. Försök igen senare.';
    console.error(err);
    return;
  }

  // Steg 2 — anslut till Socket.IO och gå med som klient
  const socket = io();
  socket.emit('join', 'client');

  // Bekräftelse från servern
  socket.on('connected', () => {
    msg.textContent = 'Ansluten — väntar på QR...';
  });

  // När administratören sänder eller ändrar QR
  socket.on('qr_update', (value) => {
    qrDiv.innerHTML = '';
    if (value) {
      msg.textContent = 'QR aktiv';
      new QRCode(qrDiv, { text: value, width: 256, height: 256 });
    } else {
      msg.textContent = 'QR dold eller inte tillgänglig';
    }
  });

  // Ping/pong för fördröjning
  socket.on('ping', (t) => socket.emit('pong', t));

  // Hantera förbjudna åtkomster
  socket.on('forbidden', (m) => {
    msg.textContent = m || 'Åtkomst nekad';
    setTimeout(() => window.location.href = '/login', 1500);
  });

  // Vid frånkoppling, visa status
  socket.on('disconnect', () => {
    msg.textContent = 'Frånkopplad från servern.';
  });
})();
</script>
</body>
</html>
