<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Klient - Support QR</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; display:flex; align-items:center; justify-content:center; flex-direction:column; height:100vh; margin:0; }
    #qr { margin-top:12px; }
    #msg { color:#333; text-align:center; }
  </style>
</head>
<body>
  <img src="https://i.postimg.cc/WzDHPTPX/logo.jpg" style="width:100px;margin-bottom:8px" alt="logo">
  <h2 id="msg">Verificerer session...</h2>
  <div id="qr"></div>

<script>
(async () => {
  const msg = document.getElementById('msg');
  const qrDiv = document.getElementById('qr');

  // Trin 1 — bed serveren om at bekræfte cookie
  try {
    const res = await fetch('/api/verify', { credentials: 'same-origin' });
    const obj = await res.json();
    if (!obj.valid) {
      // Dette vil få serveren til at omdirigere til /login ved næste sideindlæsning
      msg.textContent = 'Adgang nægtet: Ugyldig session. Opdater siden.';
      return;
    }
    // gyldig
    msg.textContent = `Velkommen, ${obj.username} — opretter forbindelse...`;
  } catch (err) {
    msg.textContent = 'Serverbekræftelse mislykkedes. Prøv igen senere.';
    console.error(err);
    return;
  }

  // Trin 2 — opret forbindelse via Socket.IO og tilslut som klient
  const socket = io();
  socket.emit('join', 'client');

  socket.on('connected', (ok) => {
    if (!ok) {
      msg.textContent = 'Afbrudt / ingen stream aktiv';
      qrDiv.innerHTML = '';
      return;
    }
    msg.textContent = 'Tilsluttet — venter på QR...';
  });

  // Indikator for administratorens tilstedeværelse
  let adminPresent = true;
  function setAdminPresent(p) {
    adminPresent = !!p;
    if (!adminPresent) {
      msg.textContent = 'Genopretter forbindelse... venter på administrator';
      qrDiv.innerHTML = '';
    }
  }

  socket.on('admin_present', (present) => {
    setAdminPresent(present);
  });

  // Hvis administratoren ikke er til stede, prøv igen hver 3. sekund
  const retryAdminLoop = setInterval(async () => {
    if (adminPresent) return;
    try {
      const res = await fetch('/api/verify', { credentials: 'same-origin' });
      const obj = await res.json();
      if (!obj.valid) return;
      // send "join" igen for at registrere klienten på ny
      socket.emit('join', 'client');
    } catch (e) { /* ignorer fejl */ }
  }, 3000);

  socket.on('qr_update', (value) => {
    qrDiv.innerHTML = '';
    if (value) {
      msg.textContent = 'QR aktiv';
      new QRCode(qrDiv, { text: value, width: 256, height: 256 });
    } else {
      msg.textContent = 'QR skjult eller ikke tilgængelig';
    }
  });

  socket.on('forbidden', (m) => {
    msg.textContent = m || 'Adgang nægtet';
    setTimeout(()=> socket.disconnect(), 100);
  });

  // ping/pong til serverens latenstidsmåling
  socket.on('ping', (t) => socket.emit('pong', t));
})();
</script>
</body>
</html>
